name: Deploy to Cloudflare Pages (Production)

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    name: Publish to Cloudflare Pages
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Validate meta.json structure
        run: |
          echo "ðŸ” Validating meta.json structure..."
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('meta.json', 'utf8'));
            if (!Array.isArray(data)) throw new Error('meta.json must be an array');
            console.log('âœ… meta.json structure is valid');
            console.log('ðŸ“Š Found', data.length, 'entries');
          "

      - name: Check for duplicates and sort order
        run: |
          echo "ðŸ” Checking for duplicates and sort order..."
          node build-scripts/process-meta.js --verbose --output /tmp/meta-test.json

      - name: Compare with original
        run: |
          echo "ðŸ” Comparing processed file with original..."
          if ! diff -q meta.json /tmp/meta-test.json > /dev/null; then
            echo "âš ï¸ meta.json needs processing (duplicates found or not sorted)"
            echo "Original entries:"
            node -e "console.log(JSON.parse(require('fs').readFileSync('meta.json', 'utf8')).length)"
            echo "Processed entries:"
            node -e "console.log(JSON.parse(require('fs').readFileSync('/tmp/meta-test.json', 'utf8')).length)"
            echo ""
            echo "To fix this, run: npm run process-meta"
            exit 1
          else
            echo "âœ… meta.json is properly deduplicated and sorted"
          fi

      - name: Validate required fields
        run: |
          echo "ðŸ” Validating required fields..."
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('meta.json', 'utf8'));
            const required = ['id', 'name', 'version', 'description', 'links', 'logo', 'tags'];
            let issues = 0;
            
            data.forEach((item, index) => {
              const missing = required.filter(field => !item[field]);
              if (missing.length > 0) {
                console.log('âŒ Entry', index, '(' + item.id + '):', 'Missing fields:', missing.join(', '));
                issues++;
              }
            });
            
            if (issues > 0) {
              console.log('ðŸš¨ Found', issues, 'entries with missing required fields');
              process.exit(1);
            } else {
              console.log('âœ… All entries have required fields');
            }
          "

      - name: Install dependencies
        working-directory: app
        run: pnpm install

      - name: Build
        working-directory: app
        run: pnpm build

      - name: Publish to Cloudflare Pages
        uses: AdrianGonz97/refined-cf-pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          projectName: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
          directory: app/dist
          deploymentName: Production
          branch: main
          wranglerVersion: "3"
